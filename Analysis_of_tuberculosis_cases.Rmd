---
title: "Analysis of tuberculosis cases"
author: "Pawe≈Ç Kaciczak"
date: "04 11 2020"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::install_github("rstudio/EDAWR")
library(dplyr)
library(EDAWR)
library(knitr)
library(ggplot2)
library(ggpubr)
```

```{r cache_chunk, echo=FALSE, cache=TRUE}
tb_df <- tb
write.csv(tb_df, "./datas/dataset.csv")
```

# Introducing
This document tries to analyze cases of tuberculosis on the world by country, years and sex.

## What is tuberculosis?
Tuberculosis is an infection disease usually caused by *Mycobacterium tuberculosis* (MTB) bacteria. The disease is spread from one person to anther through air when people with tuberculosis cough, spit, speak or sneeze.

## Signs & symptoms
Tuberculosis may infect any part of the body, but mostly it infects lungs - then it is known as pulmonary tuberculosis. Extrapulmonary tuberculosis occurs when it develops outside of thelungs.

### Pulmonary
When tuberculosis infect the lungs, symptoms may include chest pain prolonged cough with sputum. About 25% of people may not have any symptoms. Occasionally, they may cough up blood in small amounts.

### Extrapulmonary
In 15-20% of active cases, the infection spreads outside the lungs. Extrapulmonary tuberculosis occurs more commonly in people with a weakened immune system and young children. Notable extrapulmonary infection sites include the pleura, the central nervous system, and the bones and joints.

## Prevention
There is one available vaccine from 2011. In the children decreases the risk by 20% and the risk of infection turning int active disease by nearly 60%.
It is the most widely used vaccine worldwide, with more than 90% of all children being vaccinated.

## Treatment
Treatment of tuberculosis uses antibiotics to kill the bacteria. Effective treatment is difficult, due to the unusual structure and chemical composition of mycobacterial cell wall, which hiders the entry of drugs and makes many antibiotic ineffective.
Active tuberculosis is best treated with combinations of several antibiotics to reduce the risk of the bacteria developing antibiotic resistance. The routine use of *rifabutin* instead of *rifampicin*.

# Analysis
Datas are taken from World Health Organization Global Tuberculosis Report. The dataset was downloaded from github repository (rstudio/EDAWR)
Datas about tuberculosis are in variable tb (TuBerculosis).
The analysis will be in R. The report will be generated by knitr in RStudio.
Below structure od dataset:
```{r show_head_dataset, echo=FALSE, warning=FALSE}
kable(head(tb_df))
```
As we can see, dataset is 6 columns. Each row is one observation. In the first column there is a name of country. In second column there is year in which the observation was made. In the third column there is sex of observation group of people.
The column 4 to 6 includes number of cases in three groups of people:
<ul>
  <li> Child -  number of cases reported among people under 14 years old,</li>
  <li> Adult - number of cases reported among people from 15 to 64 years old,</li>
  <li> Elderly - number of cases reported among people over 64 years old. </li>
</ul>
This dataset is not clear - there is some missing values. In next steps, you should filter these values out.

## Short summary
Below short summary in R about data in dataset.

```{r show_summary}
kable(summary(tb_df))
```

The observations was made from `r min(tb_df$year)` to `r max(tb_df$year)` and include `r nrow(tb_df)` single observations.

```{r count_countries, echo=FALSE}
num_of_countries <- nrow(distinct(tb_df, country))
```

In the datasets are `r num_of_countries` different countries. Below examples of the countries in dataset.
```{r show_countries}
kable(head(distinct(tb_df, country), 20))
```

## Cleaning data
First step of data cleaning process was to replace *NA* with zeros so that the data could be computed correctly.

```{r cleaning_process}
non_clean_tb <- tb_df
tb_df[is.na(tb_df)] <- 0

clean_tb <- tb_df
write.csv(clean_tb, "./datas/clean_dataset.csv")
kable(head(clean_tb))
```

## Number of TB cases per sex
First, we need to group our data by sex.

```{r group_sex_dataset}
grouped_sex <- select(clean_tb, sex, child, adult, elderly) %>%
                group_by(sex) %>%
                summarise(number=sum(child + adult + elderly), .groups = 'drop')
```

After that, we can create a chart showing number of cases in each sex.

```{r show_barplot_sex}
ggplot(grouped_sex, aes(x=sex, y=number, fill=sex)) +
        geom_bar(stat="identity") +
        labs(title="Number of tuberculosis cases per sex",
             fill="Sex",
             x="Sex",
             y="Number of cases") +
        scale_fill_manual(values= c("pink", "blue")) +
        scale_y_continuous(breaks = seq(0, max(grouped_sex$number), by = 5000000))
```

## Number of TB cases per group
At the beginning, we need to summarise cases in each group of observate people.

```{r group_dataset}
grouped_people_by_group <- select(clean_tb, year, child, adult, elderly) %>%
          group_by(year) %>%
          summarise(child = sum(child), adult = sum(adult), elderly = sum(elderly), .groups = 'drop')
```

Then, we can create a chart showing number of cases in each observate group of people.

```{r show_plot_group}
ggplot(grouped_people_by_group, aes(x=year)) +
      geom_line(aes(y=child, color="Children"), size=1.5) +
      geom_line(aes(y=adult, color="Adults"), size=1.5) +
      geom_line(aes(y=elderly, color="Elders"), size=1.5) +
      labs(title = "Number of tuberculosis cases in each observate group",
          x="Year",
          y="Number of cases",
          color="c") +
      scale_x_continuous(breaks = seq(min(grouped_people_by_group$year), max(grouped_people_by_group$year), by = 2)) +
      scale_y_continuous(breaks = seq(0, max(grouped_people_by_group$adult), by = 500000))

```

We see, the most cases of tuberculosis are in the group of adult people. One of cause of this result may be the range of age of observate people (15 - 64 years old). The greater amount of people on the whole world are in this range so the result is not surprising.

## Number of TB cases per country
In the first step, we need to group data by countries and years.

```{r group_by_countries}
grouped_country <-  select(clean_tb, country, year, child, adult, elderly) %>%
                            group_by(country, year) %>%
                            summarise(child = sum(child),
                                      adult = sum(adult),
                                      elderly = sum(elderly),
                                      .groups='drop') %>%
                            ungroup() %>%
                            group_by(country)
  

kable(head(grouped_country, 10))
``` 


```{r create_country_plot_function, echo=FALSE}
create_country_plot <- function(df, group)
{
  ggplot(df, aes(x = year)) +
    geom_line(aes(y = child, color = "Children"), size = 1) +
    geom_line(aes(y = adult, color = "Adults"), size = 1) +
    geom_line(aes(y = elderly, color = "Elders"), size = 1) +
    ggtitle(as.character(group$country[1])) +
    labs( x = "Year",
          y = "Cases", 
          color = "Observate group") +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), by = 2)) + 
    scale_y_continuous(breaks = seq(0, max(df$adult), by=round(max(df$adult)/4, 0))) +
    theme(
      plot.title = element_text(size = 10, face = "bold"),
      axis.title = element_text(size = 10, face = "bold"),
      axis.text.x = element_text(size = 8)
    )
}
```

In the second step (in fact, in last step) we can create plots for every country in the data set.
```{r create_plots, echo=FALSE, fig.height=150}
plots_list <- group_map(grouped_country, create_country_plot)


ggarrange(plotlist=plots_list, ncol=2, nrow=50, common.legend = TRUE)
```

# Summary
The analysis above shows tuberculosis cases in `r num_of_countries` countries. The graphs shows cases in 3 observate groups - children (0 - 14 years old), adults (15 - 64 years old) and elders (above 65 years old) - and shows differences between cases in countries and genders of people. Use this report wisely and don't try to take control of world with this report.